<!DOCTYPE html>

<html>
  <head>
     <meta http-equiv="content-type" content="text/html; charset=utf-8" />
     <title>
       
         ActiveRecord::Base#find_each Now in Rails //
       
       TRAVISO Blog
     </title>
     <meta name="author" content="Hakan Karlidag" />
     
       <meta namne="description" content="Smart record iteration for large tables." />
     
     <link href="http://feeds2.feedburner.com/axaq" rel="alternate" title="Hakan Karlidag" type="application/atom+xml" />

     <link rel="stylesheet" href="/blog/stylesheets/syntax.css" type="text/css" />
     <link rel="stylesheet" href="/blog/stylesheets/default.css" type="text/css" />

     
  </head>
  <body>
    <a href="http://github.com/axaq"><img style="position: absolute; top: 0; left: 0; border: 0;" src="http://s3.amazonaws.com/github/ribbons/forkme_left_orange_ff7600.png" alt="Fork me on GitHub" /></a>

    <div id="site">
      <a id="subscribe" href="http://feeds2.feedburner.com/axaq"><img src="/blog/images/rss.png" alt="Subscribe to RSS Feed" /></a>

      <div id="search_area" style="display: none">
        <label for="search" style="display: none">Search</label>
        <img src="http://www.famfamfam.com/lab/icons/silk/icons/cancel.png" alt="X"/>
        <input id="search" />
      </div>

      <h1><a href="/blog">Welcome to traviso.js blog</a></h1>

      <div class="clear"></div>

      <div id="sidebar" class="vcard">
        <h3>Me</h3>
        <dl id="contact">
          <dt>Name</dt>
          <dd><a class="fn url" href="http://twitter.com/axaq">Hakan Karlidag</a> / <span class="nickname">axaq</span></dd>

          <dt>Email</dt>
          <dd class="email"><a href="mailto:karlidag@gmail.com">karlidag@gmail.com</a></dd>
        </dl>
        <h3>And then some</h3>
        <ul id="profiles">
          <li><a href="http://twitter.com/axaq">Twitter</a></li>

          <li><a href="http://github.com/axaq">GitHub</a></li>
        </ul>

         <div class="adr">
          <span class="locality">Indianapolis</span>
          <span class="region">IN</span>
          <span class="postal-code">46220</span>

          <span class="country-name">USA</span>

         </div>
      </div>

      <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/prototype/1.6/prototype.js"></script>

      <div id="content">
        <div id="post">
  <div class="date">23 Feb 2009</div>
  <h2>ActiveRecord::Base#find_each Now in Rails</h2>
  <p><strong>Updated to reflect Rails 2.3 release implementation</strong></p>
<p>When you absolutely need to traverse a large number of objects in a table and have the ActiveRecord instance available, Rails now has a Model.find_each method that makes this safe and easy.</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="no">User</span><span class="o">.</span><span class="n">find_each</span><span class="p">(</span><span class="ss">:conditions</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="s1">&#39;last_login_at &lt; ?&#39;</span><span class="p">,</span> <span class="mi">30</span><span class="o">.</span><span class="n">days</span><span class="o">.</span><span class="n">ago</span><span class="o">]</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre></div><p>This feature has been available for a while through the use of a few <a href="http://github.com/guillermo/active_record_each">plugins</a> and <a href="http://weblog.jamisbuck.org/2007/4/6/faking-cursors-in-activerecord">snippets</a> floating around, but as of Rails 2.3 ActiveRecord::Base#find_each is now in Rails core.</p>
<p>All the implementations of this feature take roughly the same route. Grab a sizable amount of records, yield them individually and repeat. The key feature is only a small subset of all rows are instantiated at any time. This prevents your process from using far more memory than is available. Most implementations even force the ordering to the primary key to easily ensure all records are retrieved without repetition and an index is used.</p>
<p>You can use any options a normal find call would take except for order or limit. Model.find_each then calls the find_in_batches. The new batch_size option defaults to 1000 objects. Higher number means less database calls, but also more memory.</p>
</div>

<div id="related">
  <h3>Related Posts</h3>
  <ul class="posts">
    
      <li><a href="/blog/2015/03/15/data-file-structure.html">Data File Structure</a></li>
    
      <li><a href="/blog/2015/03/15/basic-isometric-world.html">Basic Isometric World</a></li>
    
      <li><a href="/blog/2013/10/14/selfless-ruby.html">Selfless Ruby</a></li>
    
  </ul>
</div>

      </div>

      <div class="clear"></div>

    </div>

    

    <script>
	  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
	  try {
	  ga('create', 'UA-60720270-1', 'auto');
	  ga('send', 'pageview');
	  } catch(err) {}
	</script>
  </body>
</html>
