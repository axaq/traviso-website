/**
 * @license
 * traviso.js - v0.0.2
 * Copyright (c) 2015, Hakan Karlidag - @axaq
 * www.travisojs.com
 *
 * Compiled: 2015-04-15
 *
 * traviso.js is licensed under the MIT License.
 * http://www.opensource.org/licenses/mit-license.php
 */
(function(){var a=this,b=b||{};b.VERSION="v0.0.1",b.pfAlgorithms={ASTAR_ORTHOGONAL:0,ASTAR_DIAGONAL:1},b.config={logEnabled:!1},b.trace=function(a){b.config.logEnabled&&console.log("TRAVISO: "+a)},b.getEngineInstance=function(a,c){return b.init(c),new b.EngineView(a)},b.init=function(a){if(a&&(b.config.logEnabled=a.logEnabled),!b.isReady){for(var c=["instantCameraZoom","followCharacter","instantCameraRelocation","instantObjectRelocation","highlightPath","highlightTargetTile","tileHighlightAnimated","mapDraggable","callbackScope","engineInstanceReadyCallback","tileSelectCallback","objectSelectCallback","objectReachedDestinationCallback","otherObjectsOnTheNextTileCallback"],d=0;d<c.length;d++)b.defineProperty(c[d]);b.directions={O:0,S:1,SW:2,W:3,NW:4,N:5,NE:6,E:7,SE:8},b.RESERVED_TEXTURE_IDS=["idle","idle_s","idle_sw","idle_w","idle_nw","idle_n","idle_ne","idle_e","idle_se","move_s","move_sw","move_w","move_nw","move_n","move_ne","move_e","move_se"],b.isReady=!0,b.trace("Traviso initiated")}},b.defineProperty=function(a){Object.defineProperty(b.EngineView.prototype,a,{get:function(){return this.config[a]},set:function(b){this.config[a]=b}})},b.loadAssetsAndData=function(a,c){if(a.config.assetsToLoad&&""!==a.config.assetsToLoad&&a.config.assetsToLoad.length>0){var d=new PIXI.AssetLoader(a.config.assetsToLoad,!1);d.onComplete=function(){b.loadData(a,c)},d.load()}else b.loadData(a,c)},b.loadData=function(a,c){if(a.mapData={},!a.config.mapDataPath)throw new Error("TRAVISO: No XML path defined for map data. Plese check your configuration object that you pass to the 'getEngineInstance' method.");this.ajaxRequest=new XMLHttpRequest,this.ajaxRequest.onreadystatechange=function(){if(4===this.readyState&&(200===this.status||-1===window.location.href.indexOf("http"))){var d,e,f,g,h,i=this.responseXML.getElementsByTagName("single_ground_image");if(i&&i.length>0){var j=i[0].getElementsByTagName("path");if(j&&j.length>0){a.mapData.singleGroundImagePath=String(j[0].firstChild.nodeValue);var k=i[0].attributes.getNamedItem("scale");k=k?parseInt(k.nodeValue,10):1,0>=k&&(k=1),a.mapData.singleGroundImageScale=k}else b.trace("Path is NOT defined for single_ground_image")}for(g=this.responseXML.getElementsByTagName("ground_map")[0],h=g.getElementsByTagName("row"),a.mapData.groundMapData=[],e=0;e<h.length;e++){for(d=String(h[e].firstChild.nodeValue).split(","),f=d.length;f--;)d[f]=0|d[f];a.mapData.groundMapData[e]=d}for(g=this.responseXML.getElementsByTagName("object_map")[0],h=g.getElementsByTagName("row"),a.mapData.objectsMapData=[],e=0;e<h.length;e++){for(d=String(h[e].firstChild.nodeValue).split(","),f=d.length;f--;)d[f]=0|d[f];a.mapData.objectsMapData[e]=d}var l=this.responseXML.getElementsByTagName("initial_controllable_location");if(l&&l.length>0){var m=l[0];a.mapData.initialControllableLocation={c:parseInt(m.attributes.getNamedItem("c").nodeValue,10),r:parseInt(m.attributes.getNamedItem("r").nodeValue,10)}}else b.trace("No initial_controllable_location defined in the XML file.");for(a.mapData.textures={},a.mapData.textures.tiles=[],a.mapData.textures.objects=[],d=this.responseXML.getElementsByTagName("tile"),e=0;e<d.length;e++)a.mapData.textures.tiles[d[e].attributes.getNamedItem("id").nodeValue]={t:d[e].firstChild&&d[e].firstChild.nodeValue?String(d[e].firstChild.nodeValue):null,m:parseInt(d[e].attributes.getNamedItem("movable").nodeValue,10)};var n=this.responseXML.getElementsByTagName("tile_highlight_image");n&&n.length>0&&n[0].firstChild&&(a.mapData.textures.tileHighlight=String(n[0].firstChild.nodeValue)),d=this.responseXML.getElementsByTagName("object");var o;for(e=0;e<d.length;e++){o={};var p=d[e].getElementsByTagName("v");if(!p||p.length<1)throw new Error("TRAVISO: No visuals defined in XML for object type: "+d[e].attributes.getNamedItem("id").nodeValue);var q,r;for(r=0;r<p.length;r++){var s=p[r],t=s.attributes.getNamedItem("id").nodeValue;if(!t||""===t||t.length<1)throw new Error("TRAVISO: A v tag without an id is detected in the XML file.");var u=s.getElementsByTagName("f");if(u&&u.length>0)for(o[t]=[],q=0;q<u.length;q++)o[t][q]=String(u[q].firstChild.nodeValue);else{var v=String(s.attributes.getNamedItem("path").nodeValue),w=String(s.attributes.getNamedItem("ext").nodeValue),x=parseInt(s.attributes.getNamedItem("number_of_frames").nodeValue,10),y=parseInt(s.attributes.getNamedItem("start_number").nodeValue,10);if(!v||!w||!x||1>x)throw new Error("TRAVISO: Misdefined v tag attributes detected in XML file for v id: "+t);if(o[t]=[],1===x)o[t][0]=v+"."+w;else{var z=0;for(q=y;x>q;q++)o[t][z++]=v+String(q)+"."+w}}}a.mapData.textures.objects[d[e].attributes.getNamedItem("id").nodeValue]={t:o,s:d[e].attributes.getNamedItem("s").nodeValue,m:parseInt(d[e].attributes.getNamedItem("movable").nodeValue,10),i:parseInt(d[e].attributes.getNamedItem("interactive").nodeValue,10)}}c&&c()}},this.ajaxRequest.open("GET",a.config.mapDataPath,!0),this.ajaxRequest.overrideMimeType&&this.ajaxRequest.overrideMimeType("application/xml"),this.ajaxRequest.send(null)},b.getObjectInfo=function(a,c){var d=a.mapData.textures.objects[c];if(d){var e={};for(var f in d.t)e[f]=b.getObjectTextures(a,c,f);return{m:d.m,i:d.i,t:e,s:d.s}}throw new Error("TRAVISO: No info defined for object type: "+c)},b.getObjectTextures=function(a,c,d){var e=a.mapData.textures.objects[c];if(e){var f=null,g=e.t[d];if(g){f=[];for(var h=0;h<g.length;h++)f[f.length]=PIXI.Texture.fromFrame(g[h])}else b.trace("No textures defined for object type: "+c+" and visualId: "+d);return f}throw new Error("TRAVISO: No info defined for object type: "+c)},b.getTileInfo=function(a,b){var c=a.mapData.textures.tiles[b];if(c)return{m:c.m,t:c.t?[PIXI.Texture.fromFrame(c.t)]:[]};if(a.mapData.singleGroundImagePath)return{m:parseInt(b)>0?1:0,t:[]};throw new Error("TRAVISO: No info defined for tile type: "+b)},b.getStationaryDirVisualId=function(a){return b.RESERVED_TEXTURE_IDS[a]},b.getMovingDirVisualId=function(a){return b.RESERVED_TEXTURE_IDS[a+8]},b.getDirBetween=function(a,c,d,e){var f=b.directions.S;return a===d?f=c===e?b.directions.O:e>c?b.directions.NE:b.directions.SW:d>a?f=c===e?b.directions.SE:e>c?b.directions.W:b.directions.S:a>d&&(f=c===e?b.directions.NW:e>c?b.directions.N:b.directions.E),f},b.mathMap=function(a,b,c,d,e,f){if(f){if(b>a)return d;if(a>c)return e}return d+(e-d)*(a-b)/(c-b)},b.dotProduct=function(a,b){return a.x*b.x+a.y*b.y},b.getUnit=function(a){var b=Math.sqrt(a.x*a.x+a.y*a.y);return{x:a.x/b,y:a.y/b}},b.isInPolygon=function(a,b){var c,d,e=a.y,f=a.x,g=b.length,h=!1;for(c=0,d=g-1;g>c;d=c++)b[c][1]>e!=b[d][1]>e&&f<(b[d][0]-b[c][0])*(e-b[c][1])/(b[d][1]-b[c][1])+b[c][0]&&(h=!h);return h},b.getDist=function(a,b){return Math.sqrt((b.x-a.x)*(b.x-a.x)+(b.y-a.y)*(b.y-a.y))},b.localToGlobal=function(a,b){for(var c=b.position.x+a.x,d=b.position.y+a.y,e=b.parent;e;)c+=e.position.x,d+=e.position.y,e=e.parent;return{x:c,y:d}},b.globalToLocal=function(a,b){for(var c=b.position.x,d=b.position.y,e=b.parent;e;)c+=e.position.x,d+=e.position.y,e=e.parent;return{x:a.x-c,y:a.y-d}},b.existy=function(a){return null!==a&&void 0!==a},b.MoveEngine=function(a,b){this.engine=a,this.DEFAULT_SPEED=b||3,this.activeForMovables=!1,this.activeForTweens=!1,this.processFrame=!0,this.movables=[],this.tweenTargets=[],this.fps=60;var c=this;requestAnimFrame(function(){c.run()})},b.MoveEngine.constructor=b.MoveEngine,b.MoveEngine.prototype.addTween=function(a,b,c,d,e,f,g){var h=null;for(var i in c)a[i]!==c[i]&&(h||(h={}),h[i]={b:a[i],c:c[i]-a[i]});if(h){var j={target:a,duration:b,delay:Number(d)||0,easingFunc:this.getEasingFunc(e),overwrite:f||!1,onComplete:g||null,totalFrames:b*this.fps,currentFrame:0,vars:h},k=this.tweenTargets.indexOf(a);if(k>=0){var l=a.tweens;if(l||(l=[]),j.overwrite){for(var m=0;m<l.length;m++)l[m]=null;l=[]}l[l.length]=j,a.tweens=l}else a.tweens=[j],this.tweenTargets[this.tweenTargets.length]=a;this.tweenTargets.length>0&&!this.activeForTweens&&(this.activeForTweens=!0)}},b.MoveEngine.prototype.removeTween=function(a,b){var c=!1;if(a&&b){var d=this.tweenTargets.indexOf(a);if(!(d>=0))throw new Error("No tween target defined for this object");if(!(this.tweenTargets[d].tweens&&this.tweenTargets[d].tweens.length>0))throw new Error("No tween defined for this object");var e=this.tweenTargets[d].tweens,f=e.indexOf(b);if(!(f>=0))throw new Error("No tween defined for this object");b.onComplete=null,b.easingFunc=null,b.target=null,e.splice(f,1),0===e.length&&(this.tweenTargets.splice(d,1),c=!0),0===this.tweenTargets.length&&(this.activeForTweens=!1)}return c},b.MoveEngine.prototype.killTweensOf=function(a){var b=!1,c=this.tweenTargets.indexOf(a);if(c>=0){if(this.tweenTargets[c].tweens&&this.tweenTargets[c].tweens.length>0){for(var d=this.tweenTargets[c].tweens,e=0;e<d.length;e++)d[e].onComplete=null,d[e].easingFunc=null,d[e].target=null,d[e]=null;this.tweenTargets[c].tweens=null}this.tweenTargets.splice(c,1),b=!0}return 0===this.tweenTargets.length&&(this.activeForTweens=!1),b},b.MoveEngine.prototype.removeAllTweens=function(){this.activeForTweens=!1;var a,b,c,d=this.tweenTargets.length;for(b=0;d>b;b++){for(a=this.tweenTargets[b].tweens,c=0;c<a.length;c++)a[c].onComplete=null,a[c].easingFunc=null,a[c].target=null,a[c]=null;this.tweenTargets[b].tweens=null,this.tweenTargets[b]=null}this.tweenTargets=[]},b.MoveEngine.prototype.addMovable=function(a){this.movables.indexOf(a)>=0||(this.movables[this.movables.length]=a,this.movables.length>0&&!this.activeForMovables&&(this.activeForMovables=!0))},b.MoveEngine.prototype.removeMovable=function(a){var b=this.movables.indexOf(a);return-1!==b&&(a.speedUnit={x:0,y:0},this.movables.splice(b,1)),0===this.movables.length&&(this.activeForMovables=!1),-1!==b},b.MoveEngine.prototype.removeAllMovables=function(){this.activeForMovables=!1;for(var a=this.movables.length,b=0;a>b;b++)this.movables[b]=null;this.movables=[]},b.MoveEngine.prototype.addNewPathToObject=function(a,b,c){a.currentPath&&a.currentTarget&&(b[b.length]=a.currentPath[a.currentPathStep]),a.currentPath=b,a.currentPathStep=a.currentPath.length-1,a.speedMagnitude=c||a.speedMagnitude||this.DEFAULT_SPEED},b.MoveEngine.prototype.prepareForMove=function(a,b,c){a.currentPath=b,a.currentPathStep=a.currentPath.length-1,a.speedMagnitude=c||a.speedMagnitude||this.DEFAULT_SPEED},b.MoveEngine.prototype.setMoveParameters=function(a,c){var d=this.engine.getTilePosXFor(c.r,c.c),e=this.engine.getTilePosYFor(c.r,c.c)+this.engine.TILE_HALF_H;a.speedUnit=b.getUnit({x:d-a.position.x,y:e-a.position.y}),a.currentTarget={x:d,y:e},a.currentReachThresh=Math.ceil(Math.sqrt(a.speedUnit.x*a.speedUnit.x+a.speedUnit.y*a.speedUnit.y)*a.speedMagnitude)},b.MoveEngine.prototype.getEasingFunc=function(a){return"easeInOut"===a||"easeInOutQuad"===a||"Quad.easeInOut"===a?this.easeInOutQuad:"easeIn"===a||"easeInQuad"===a||"Quad.easeIn"===a?this.easeInQuad:"easeOut"===a||"easeOutQuad"===a||"Quad.easeOut"===a?this.easeOutQuad:this.linearTween},b.MoveEngine.prototype.linearTween=function(a,b,c,d){return c*a/d+b},b.MoveEngine.prototype.easeInQuad=function(a,b,c,d){return a/=d,c*a*a+b},b.MoveEngine.prototype.easeOutQuad=function(a,b,c,d){return a/=d,-c*a*(a-2)+b},b.MoveEngine.prototype.easeInOutQuad=function(a,b,c,d){return a/=d/2,1>a?c/2*a*a+b:(a--,-c/2*(a*(a-2)-1)+b)},b.MoveEngine.prototype.run=function(){if(this.processFrame){var a,c,d;if(this.activeForMovables){a=this.movables.length;var e;for(d=0;a>d;d++)c=this.movables[d],c.prevPosition={x:c.position.x,y:c.position.y},c.currentTarget&&(e=b.getDist(c.position,c.currentTarget),e<=c.currentReachThresh)?(c.position.x=c.currentTarget.x,c.position.y=c.currentTarget.y,this.engine.onObjMoveStepEnd(c),d--,a--):(c.position.x+=c.speedMagnitude*c.speedUnit.x,c.position.y+=c.speedMagnitude*c.speedUnit.y,this.engine.checkForTileChange(c))}if(this.activeForTweens){a=this.tweenTargets.length;var f,g,h,i;for(d=0;a>d;d++)for(c=this.tweenTargets[d],g=c.tweens,h=0;h<g.length;h++){f=g[h],f.currentFrame++,i=f.vars;for(var j in i)c[j]=f.easingFunc(f.currentFrame,i[j].b,i[j].c,f.totalFrames);f.currentFrame>=f.totalFrames&&(f.onComplete&&f.onComplete(),this.removeTween(c,f)&&(d--,a--),h--)}}var k=this;requestAnimFrame(function(){k.run()})}},b.MoveEngine.prototype.destroy=function(){b.trace("MoveEngine destroy"),this.processFrame=!1,this.removeAllMovables(),this.removeAllTweens(),this.movables=null,this.tweenTargets=null,this.engine=null},b.PathFinding=function(a,c,d){var e=0,f=0;for(d=d||{},this.nodes=[],this.diagonal=!!d.diagonal,this.heuristic=this.diagonal?this.heuristics.diagonal:this.heuristics.manhattan,this.grid=[],e=0;a>e;e++)for(this.grid[e]=[],f=0;c>f;f++){var g=new b.PathFinding.GridNode(e,f,1);this.grid[e][f]=g,this.nodes.push(g)}this.init()},b.PathFinding.constructor=b.PathFinding,b.PathFinding.prototype.init=function(){this.dirtyNodes=[];for(var a=0;a<this.nodes.length;a++)this.cleanNode(this.nodes[a])},b.PathFinding.prototype.cleanDirty=function(){for(var a=0;a<this.dirtyNodes.length;a++)this.cleanNode(this.dirtyNodes[a]);this.dirtyNodes=[]},b.PathFinding.prototype.markDirty=function(a){this.dirtyNodes.push(a)},b.PathFinding.prototype.neighbors=function(a){var b=[],c=a.x,d=a.y,e=this.grid;return e[c-1]&&e[c-1][d]&&b.push(e[c-1][d]),e[c+1]&&e[c+1][d]&&b.push(e[c+1][d]),e[c]&&e[c][d-1]&&b.push(e[c][d-1]),e[c]&&e[c][d+1]&&b.push(e[c][d+1]),this.diagonal&&(e[c-1]&&e[c-1][d-1]&&b.push(e[c-1][d-1]),e[c+1]&&e[c+1][d-1]&&b.push(e[c+1][d-1]),e[c-1]&&e[c-1][d+1]&&b.push(e[c-1][d+1]),e[c+1]&&e[c+1][d+1]&&b.push(e[c+1][d+1])),b},b.PathFinding.prototype.toString=function(){for(var a,b,c,d,e=[],f=this.grid,g=0,h=f.length;h>g;g++){for(a=[],b=f[g],c=0,d=b.length;d>c;c++)a.push(b[c].weight);e.push(a.join(" "))}return e.join("\n")},b.PathFinding.GridNode=function(a,b,c){this.x=a,this.y=b,this.weight=c,this.mapPos={c:a,r:b}},b.PathFinding.GridNode.constructor=b.PathFinding.GridNode,b.PathFinding.GridNode.prototype.toString=function(){return"["+this.x+" "+this.y+"]"},b.PathFinding.GridNode.prototype.getCost=function(a){return a&&a.x!==this.x&&a.y!==this.y?1.41421*this.weight:this.weight},b.PathFinding.GridNode.prototype.isWall=function(){return 0===this.weight},b.PathFinding.prototype.solve=function(a,b,c,d){var e=this.grid[a][b],f=this.grid[c][d],g=this.search(e,f,{heuristic:this.heuristic});return g&&g.length>0?g:null},b.PathFinding.prototype.getAdjacentOpenCells=function(a,b,c,d){var e,f,g=[];for(e=b;e>b-d;e--)for(f=a;a+c>f;f++)g=g.concat(this.neighbors(this.grid[f][e]));return g},b.PathFinding.prototype.pathTo=function(a){for(var b=a,c=[];b.parent;)c.push(b),b=b.parent;return c},b.PathFinding.prototype.getHeap=function(){return new b.PathFinding.BinaryHeap(function(a){return a.f})},b.PathFinding.prototype.search=function(a,b,c){this.init(),c=c||{};var d=c.heuristic||this.heuristics.manhattan,e=c.closest||!1,f=this.getHeap(),g=a;for(a.h=d(a,b),f.push(a);f.size()>0;){var h=f.pop();if(h===b)return this.pathTo(h);h.closed=!0;for(var i=this.neighbors(h),j=0,k=i.length;k>j;++j){var l=i[j];if(!l.closed&&!l.isWall()){var m=h.g+l.getCost(h),n=l.visited;(!n||m<l.g)&&(l.visited=!0,l.parent=h,l.h=l.h||d(l,b),l.g=m,l.f=l.g+l.h,this.markDirty(l),e&&(l.h<g.h||l.h===g.h&&l.g<g.g)&&(g=l),n?f.rescoreElement(l):f.push(l))}}}return e?this.pathTo(g):[]},b.PathFinding.prototype.heuristics={manhattan:function(a,b){var c=Math.abs(b.x-a.x),d=Math.abs(b.y-a.y);return c+d},diagonal:function(a,b){var c=1,d=Math.sqrt(2),e=Math.abs(b.x-a.x),f=Math.abs(b.y-a.y);return c*(e+f)+(d-2*c)*Math.min(e,f)}},b.PathFinding.prototype.cleanNode=function(a){a.f=0,a.g=0,a.h=0,a.visited=!1,a.closed=!1,a.parent=null},b.PathFinding.BinaryHeap=function(a){this.content=[],this.scoreFunction=a},b.PathFinding.BinaryHeap.prototype={push:function(a){this.content.push(a),this.sinkDown(this.content.length-1)},pop:function(){var a=this.content[0],b=this.content.pop();return this.content.length>0&&(this.content[0]=b,this.bubbleUp(0)),a},remove:function(a){var b=this.content.indexOf(a),c=this.content.pop();b!==this.content.length-1&&(this.content[b]=c,this.scoreFunction(c)<this.scoreFunction(a)?this.sinkDown(b):this.bubbleUp(b))},size:function(){return this.content.length},rescoreElement:function(a){this.sinkDown(this.content.indexOf(a))},sinkDown:function(a){for(var b=this.content[a];a>0;){var c=(a+1>>1)-1,d=this.content[c];if(!(this.scoreFunction(b)<this.scoreFunction(d)))break;this.content[c]=b,this.content[a]=d,a=c}},bubbleUp:function(a){for(var b=this.content.length,c=this.content[a],d=this.scoreFunction(c);;){var e,f=a+1<<1,g=f-1,h=null;if(b>g){var i=this.content[g];e=this.scoreFunction(i),d>e&&(h=g)}if(b>f){var j=this.content[f],k=this.scoreFunction(j);(null===h?d:e)>k&&(h=f)}if(null===h)break;this.content[a]=this.content[h],this.content[h]=c,a=h}}},b.PathFinding.prototype.isCellFilled=function(a,b){return 0===this.grid[a][b].weight?!0:!1},b.PathFinding.prototype.setCell=function(a,b,c){this.grid[a][b].staticWeight=this.grid[a][b].weight=c},b.PathFinding.prototype.setDynamicCell=function(a,b,c){0!==this.grid[a][b].staticWeight&&(this.grid[a][b].weight=c)},b.PathFinding.prototype.destroy=function(){b.trace("PathFinding destroy"),this.grid=null,this.nodes=null,this.dirtyNodes=null},b.ObjectView=function(a,c,d){PIXI.DisplayObjectContainer.call(this),this.engine=a,this.type=c||0;var e=b.getObjectInfo(this.engine,this.type);this.isMovableTo=e.m,this.isInteractive=e.i;var f=e.s.split("x");this.size={r:parseInt(f[0],10),c:parseInt(f[1],10)};var g=this.size.r/(this.size.c+this.size.r);this.textures=e.t,this.container=new PIXI.MovieClip(this.textures.idle),this.container.anchor.x=g,this.container.anchor.y=1,this.addChild(this.container),this.animSpeed=d,this.container.gotoAndStop(0),this.firstTextureHeight=this.container.textures[0].height},b.ObjectView.constructor=b.ObjectView,b.ObjectView.prototype=Object.create(PIXI.DisplayObjectContainer.prototype),Object.defineProperty(b.ObjectView.prototype,"animSpeed",{get:function(){return this.container.animationSpeed},set:function(a){this.container.animationSpeed=b.existy(a)&&a>0?a:.5}}),b.ObjectView.prototype.changeVisualToDirection=function(a,c,d,e,f,g){if(!this.changeVisual(c?b.getMovingDirVisualId(a):b.getStationaryDirVisualId(a),d,e,f,g)&&!this.changeVisual("idle",d,e,f,g))throw new Error("no 'idle' visual defined as backup for object type "+this.type)},b.ObjectView.prototype.changeVisual=function(a,c,d,e,f){if(!this.textures[a])return!1;if(this.container.textures=this.textures[a],!c&&this.textures[a].length>1){if(this.container.loop=!d,d&&e){var g=this;this.container.onComplete=function(){setTimeout(function(){e.call(g.engine.config.callbackScope,g)},100)}}b.existy(f)&&f>0&&(this.animSpeed=f),this.container.gotoAndPlay(0)}else this.container.gotoAndStop(0);return!0},b.ObjectView.prototype.destroy=function(){this.container&&(this.engine=null,this.size=null,this.textures=null,this.container.onComplete=null,this.container=null)},b.TileView=function(a,c){PIXI.DisplayObjectContainer.call(this),this.engine=a,this.type=c||"0";var d=this.engine.TILE_HALF_H,e=this.engine.TILE_HALF_W;this.vertices=[[-e,0],[0,-d],[e,0],[0,d]];var f=b.getTileInfo(this.engine,this.type);if(this.isMovableTo=f.m,f.t.length>0&&(this.tileGraphics=new PIXI.MovieClip(f.t),this.tileGraphics.anchor.x=.5,this.tileGraphics.anchor.y=.5,this.addChild(this.tileGraphics),this.tileGraphics.gotoAndStop(this.type)),this.engine.mapData.textures.tileHighlight)this.highlightedOverlay=new PIXI.Sprite.fromFrame(this.engine.mapData.textures.tileHighlight),this.highlightedOverlay.anchor.x=.5,this.highlightedOverlay.anchor.y=.5,this.addChild(this.highlightedOverlay);else{this.highlightedOverlay=new PIXI.Graphics,this.highlightedOverlay.clear(),this.highlightedOverlay.lineStyle(2,16777215,1),this.highlightedOverlay.beginFill(8443903,.5),this.highlightedOverlay.moveTo(this.vertices[0][0],this.vertices[0][1]);for(var g=1;g<this.vertices.length;g++)this.highlightedOverlay.lineTo(this.vertices[g][0],this.vertices[g][1]);this.highlightedOverlay.lineTo(this.vertices[0][0],this.vertices[0][1]),this.highlightedOverlay.endFill(),this.addChild(this.highlightedOverlay)}this.highlightedOverlay.scale.x=this.highlightedOverlay.scale.y=.1,this.highlightedOverlay.visible=!1,this.highlightedOverlay.scale.scope=this.highlightedOverlay,this.highlightedOverlay.scale.isHighlighted=this.isHighlighted=!1},b.TileView.constructor=b.TileView,b.TileView.prototype=Object.create(PIXI.DisplayObjectContainer.prototype),b.TileView.prototype.setHighlighted=function(a,b){if(this.isHighlighted!==a){if(b)return this.highlightedOverlay.scale.x=this.highlightedOverlay.scale.y=a?1:.1,this.highlightedOverlay.visible=a,void(this.highlightedOverlay.scale.isHighlighted=this.isHighlighted=a);a&&(this.highlightedOverlay.visible=a),this.highlightedOverlay.scale.isHighlighted=this.isHighlighted=a;var c=a?1:.1;this.highlightedOverlay.scale.x===c?this.highlightedOverlay.visible=a:(this.highlightedOverlay.scale.x=this.highlightedOverlay.scale.y=a?.1:1,this.engine.moveEngine.addTween(this.highlightedOverlay.scale,.5,{x:c,y:c},0,"linear",!0,function(){this.target.scope.visible=this.target.isHighlighted}))}},b.TileView.prototype.destroy=function(){this.engine&&(this.engine&&this.engine.moveEngine&&this.engine.moveEngine.killTweensOf(this.highlightedOverlay.scale),this.engine=null,this.highlightedOverlay.scale.scope=null,this.highlightedOverlay=null,this.tileGraphics=null)},b.EngineView=function(a){PIXI.DisplayObjectContainer.call(this),this.config=a||{},this.config.followCharacter=b.existy(this.config.followCharacter)?this.config.followCharacter:!0,this.config.highlightPath=b.existy(this.config.highlightPath)?this.config.highlightPath:!0,this.config.highlightTargetTile=b.existy(this.config.highlightTargetTile)?this.config.highlightTargetTile:!0,this.config.tileHighlightAnimated=b.existy(this.config.tileHighlightAnimated)?this.config.tileHighlightAnimated:!0,this.config.mapDraggable=b.existy(this.config.mapDraggable)?this.config.mapDraggable:!0,this.setZoomParameters(this.config.minScale,this.config.maxScale,this.config.numberOfZoomLevels,this.config.initialZoomLevel,this.config.instantCameraZoom),this.TILE_H=this.config.tileHeight||74,this.ISO_ANGLE=this.config.isoAngle||30,this.TILE_HALF_H=this.TILE_H/2,this.TILE_HALF_W=this.TILE_HALF_H*Math.tan((90-this.ISO_ANGLE)*Math.PI/180),this.TILE_W=2*this.TILE_HALF_W,this.TILE_ISO_EDGE_L=this.TILE_H;var c=this;b.loadAssetsAndData(this,function(){c.onAllAssetsLoaded()})},b.EngineView.constructor=b.EngineView,b.EngineView.prototype=Object.create(PIXI.DisplayObjectContainer.prototype),b.EngineView.prototype.config=this.config,b.EngineView.prototype.onAllAssetsLoaded=function(){b.trace("onAllAssetsLoaded"),this.moveEngine=new b.MoveEngine(this),this.currentScale=1,this.currentZoom=0,this.posFrame=this.config.initialPositionFrame||{x:0,y:0,w:800,h:600},this.externalCenter={x:this.posFrame.w>>1,y:this.posFrame.h>>1},this.createMap(),this.repositionContent(this.config.initialPositionFrame),this.enableInteraction(),this.config.engineInstanceReadyCallback&&this.config.engineInstanceReadyCallback.call(this.config.callbackScope,this)},b.EngineView.prototype.createMap=function(){this.config.backgroundColor&&(this.bg=new PIXI.Graphics,this.addChild(this.bg)),this.config.useMask&&(this.mapMask=new PIXI.Graphics,this.addChild(this.mapMask)),this.mapContainer=new PIXI.DisplayObjectContainer,this.addChild(this.mapContainer),this.groundContainer=new PIXI.DisplayObjectContainer,this.mapContainer.addChild(this.groundContainer),this.objContainer=new PIXI.DisplayObjectContainer,this.mapContainer.addChild(this.objContainer);var a=this.mapData.groundMapData,c=this.mapData.objectsMapData,d=this.mapData.initialControllableLocation;this.mapSizeR=a.length,this.mapSizeC=a[0].length;var e;this.mapData.singleGroundImagePath&&(e=new PIXI.Sprite.fromFrame(this.mapData.singleGroundImagePath),this.groundContainer.addChild(e),e.scale.set(this.mapData.singleGroundImageScale)),this.tileArray=[],this.objArray=[];var f,g;for(f=0;f<this.mapSizeR;f++)for(this.tileArray[f]=[],this.objArray[f]=[],g=0;g<this.mapSizeC;g++)this.tileArray[f][g]=null,this.objArray[f][g]=null;this.pathFinding=new b.PathFinding(this.mapSizeC,this.mapSizeR,{diagonal:this.config.pathFinding===b.pfAlgorithms.ASTAR_DIAGONAL});var h;for(f=0;f<this.mapSizeR;f++)for(g=this.mapSizeC-1;g>=0;g--)this.tileArray[f][g]=null,a[f][g]?(h=new b.TileView(this,a[f][g]),h.position.x=this.getTilePosXFor(f,g),h.position.y=this.getTilePosYFor(f,g),h.mapPos={c:g,r:f},this.tileArray[f][g]=h,this.groundContainer.addChild(h),h.isMovableTo||this.pathFinding.setCell(g,f,0)):this.pathFinding.setCell(g,f,0);var i;for(f=0;f<this.mapSizeR;f++)for(g=this.mapSizeC-1;g>=0;g--)this.objArray[f][g]=null,c[f][g]&&(i=new b.ObjectView(this,c[f][g]),i.position.x=this.getTilePosXFor(f,g),i.position.y=this.getTilePosYFor(f,g)+this.TILE_HALF_H,i.mapPos={c:g,r:f},this.objContainer.addChild(i),this.addObjRefToLocation(i,i.mapPos),d&&d.c===g&&d.r===f&&(this.currentControllable=i));this.mapVertices=[[this.getTilePosXFor(0,0)-this.TILE_HALF_W,this.getTilePosYFor(0,0)],[this.getTilePosXFor(0,this.mapSizeC-1),this.getTilePosYFor(0,this.mapSizeC-1)-this.TILE_HALF_H],[this.getTilePosXFor(this.mapSizeR-1,this.mapSizeC-1)+this.TILE_HALF_W,this.getTilePosYFor(this.mapSizeR-1,this.mapSizeC-1)],[this.getTilePosXFor(this.mapSizeR-1,0),this.getTilePosYFor(this.mapSizeR-1,0)+this.TILE_HALF_H]],this.mapVisualWidthReal=this.getTilePosXFor(this.mapSizeR-1,this.mapSizeC-1)-this.getTilePosXFor(0,0),this.mapVisualHeightReal=this.getTilePosYFor(this.mapSizeR-1,0)-this.getTilePosYFor(0,this.mapSizeC-1),e&&(e.position.x=this.mapVertices[0][0]+this.TILE_HALF_W+(this.mapVisualWidthReal-e.width)/2,e.position.y=this.mapVertices[1][1]+this.TILE_HALF_H+(this.mapVisualHeightReal-e.height)/2),this.zoomTo(this.config.initialZoomLevel,!0),this.config.followCharacter&&d?this.centralizeToLocation(d.c,d.r,!0):this.centralizeToCurrentExternalCenter(!0)},b.EngineView.prototype.getTilePosXFor=function(a,b){return b*this.TILE_HALF_W+a*this.TILE_HALF_W},b.EngineView.prototype.getTilePosYFor=function(a,b){return a*this.TILE_HALF_H-b*this.TILE_HALF_H},b.EngineView.prototype.showHideObjectLayer=function(a){this.objContainer.visible=a},b.EngineView.prototype.showHideGroundLayer=function(a){this.groundContainer.visible=a},b.EngineView.prototype.getTileAtRowAndColumn=function(a,b){return this.tileArray[a][b]},b.EngineView.prototype.getObjectsAtRowAndColumn=function(a,b){return this.objArray[a][b]},b.EngineView.prototype.getObjectsAtLocation=function(a){return this.objArray[a.r][a.c]},b.EngineView.prototype.createAndAddObjectToLocation=function(a,c){return this.addObjectToLocation(new b.ObjectView(this,a),c)},b.EngineView.prototype.addObjectToLocation=function(a,b){return a.position.x=this.getTilePosXFor(b.r,b.c),a.position.y=this.getTilePosYFor(b.r,b.c)+this.TILE_HALF_H,a.mapPos={c:b.c,r:b.r},this.objContainer.addChild(a),this.addObjRefToLocation(a,a.mapPos),this.arrangeDepthsFromLocation(a.mapPos),a},b.EngineView.prototype.addCustomObjectToLocation=function(a,c){return a.isMovableTo=b.existy(a.isMovableTo)?a.isMovableTo:!0,a.size=a.size||{c:1,r:1},this.addObjectToLocation(a,c)},b.EngineView.prototype.removeObjectFromLocation=function(a,b){b=b||a.mapPos,this.objContainer.removeChild(a),this.removeObjRefFromLocation(a,b)},b.EngineView.prototype.focusMapToObject=function(a){this.focusMapToLocation(a.mapPos.c+(a.size.c-1)/2,a.mapPos.r-(a.size.r-1)/2,0)},b.EngineView.prototype.focusMapToLocation=function(a,b,c){this.zoomTo(c,!1),this.centralizeToLocation(a,b)},b.EngineView.prototype.centralizeToObject=function(a){this.centralizeToLocation(a.mapPos.c,a.mapPos.r)},b.EngineView.prototype.centralizeToLocation=function(a,b,c){this.currentFocusLocation={c:a,r:b};var d=this.externalCenter.x+(this.mapVisualWidthScaled>>1)-this.getTilePosXFor(b,a)*this.currentScale,e=this.externalCenter.y-this.getTilePosYFor(b,a)*this.currentScale;this.centralizeToPoint(d,e,c)},b.EngineView.prototype.centralizeToCurrentFocusLocation=function(a){this.centralizeToLocation(this.currentFocusLocation.c,this.currentFocusLocation.r,a)},b.EngineView.prototype.centralizeToCurrentExternalCenter=function(a){this.externalCenter&&(this.currentFocusLocation={c:this.mapSizeC>>1,r:this.mapSizeR>>1},this.centralizeToPoint(this.externalCenter.x,this.externalCenter.y,a))},b.EngineView.prototype.centralizeToPoint=function(a,c,d){this.tileArray&&(a-=this.mapVisualWidthScaled>>1,b.existy(d)&&d||!b.existy(d)&&this.config.instantCameraRelocation?(this.mapContainer.position.x=a,this.mapContainer.position.y=c):this.moveEngine.addTween(this.mapContainer.position,.5,{x:a,y:c},0,"easeInOut",!0))},b.EngineView.prototype.setZoomParameters=function(a,c,d,e,f){this.config.minScale=b.existy(a)?a:.5,this.config.maxScale=b.existy(c)?c:1.5,this.config.minZoom=-1,this.config.maxZoom=1,this.config.zoomIncrement=b.existy(d)?1>=d?0:2/(d-1):.5,this.config.initialZoomLevel=b.existy(e)?e:0,this.config.instantCameraZoom=b.existy(f)?f:!1},b.EngineView.prototype.setScale=function(a,c){a<this.config.minScale?a=this.config.minScale:a>this.config.maxScale&&(a=this.config.maxScale),this.currentScale=a,this.mapVisualWidthScaled=this.mapVisualWidthReal*this.currentScale,this.mapVisualHeightScaled=this.mapVisualHeightReal*this.currentScale,b.existy(c)&&c||!b.existy(c)&&this.config.instantCameraZoom?this.mapContainer.scale.set(this.currentScale):this.moveEngine.addTween(this.mapContainer.scale,.5,{x:this.currentScale,y:this.currentScale},0,"easeInOut",!0)},b.EngineView.prototype.zoomTo=function(a,c){a=a||0;var d=b.mathMap(a,this.config.minZoom,this.config.maxZoom,this.config.minScale,this.config.maxScale,!0);d=Math.round(10*d)/10,this.currentZoom=b.mathMap(d,this.config.minScale,this.config.maxScale,this.config.minZoom,this.config.maxZoom,!0),this.externalCenter=this.externalCenter?this.externalCenter:{x:this.mapVisualWidthScaled>>1,y:0};var e={x:this.mapContainer.position.x+(this.mapVisualWidthScaled>>1)-this.externalCenter.x,y:this.mapContainer.position.y-this.externalCenter.y},f=this.currentScale;this.setScale(d,c);var g=this.currentScale/f;this.centralizeToPoint(this.externalCenter.x+e.x*g,this.externalCenter.y+e.y*g,b.existy(c)&&c||!b.existy(c)&&this.config.instantCameraZoom)},b.EngineView.prototype.zoomOut=function(a){this.zoomTo(this.currentZoom-this.config.zoomIncrement,a)},b.EngineView.prototype.zoomIn=function(a){this.zoomTo(this.currentZoom+this.config.zoomIncrement,a)},b.EngineView.prototype.getCurrentControllable=function(){return this.currentControllable},b.EngineView.prototype.setCurrentControllable=function(a){this.currentControllable=a},b.EngineView.prototype.addObjRefToLocation=function(a,b){for(var c=b.c;c<b.c+a.size.c;c++)for(var d=b.r;d>b.r-a.size.r;d--)this.addObjRefToSingleLocation(a,{c:c,r:d})},b.EngineView.prototype.addObjRefToSingleLocation=function(a,b){this.objArray[b.r][b.c]||(this.objArray[b.r][b.c]=[]);var c=this.objArray[b.r][b.c].indexOf(a);0>c&&this.objArray[b.r][b.c].push(a),a.isMovableTo||this.pathFinding.setDynamicCell(b.c,b.r,0)},b.EngineView.prototype.removeObjRefFromLocation=function(a,b){for(var c=b.c;c<b.c+a.size.c;c++)for(var d=b.r;d>b.r-a.size.r;d--)this.removeObjRefFromSingleLocation(a,{c:c,r:d})},b.EngineView.prototype.removeObjRefFromSingleLocation=function(a,b){if(this.objArray[b.r][b.c]){var c=this.objArray[b.r][b.c].indexOf(a);if(c>-1&&this.objArray[b.r][b.c].splice(c,1),0===this.objArray[b.r][b.c].length)this.pathFinding.setDynamicCell(b.c,b.r,1),this.objArray[b.r][b.c]=null;else for(var d=this.objArray[b.r][b.c],e=d.length,f=0;e>f;f++){if(!d[f].isMovableTo){this.pathFinding.setDynamicCell(b.c,b.r,0);break}f===e-1&&this.pathFinding.setDynamicCell(b.c,b.r,1)}}},b.EngineView.prototype.removeAllObjectRefsFromLocation=function(a){this.objArray[a.r][a.c]&&(this.pathFinding.setDynamicCell(a.c,a.r,1),this.objArray[a.r][a.c]=null)},b.EngineView.prototype.changeObjAlphasInLocation=function(a,b){var c=this.objArray[b.r][b.c];if(c)for(var d=c.length,e=0;d>e;e++)c[e].alpha=a
},b.EngineView.prototype.arrangeObjLocation=function(a,b){this.removeObjRefFromLocation(a,a.mapPos),this.addObjRefToLocation(a,b),a.mapPos={c:b.c,r:b.r}},b.EngineView.prototype.arrangeObjTransperancies=function(a,b,c){this.currentControllable===a&&(b.c>0&&this.changeObjAlphasInLocation(1,{c:b.c-1,r:b.r}),b.c>0&&b.r<this.mapSizeR-1&&this.changeObjAlphasInLocation(1,{c:b.c-1,r:b.r+1}),b.r<this.mapSizeR-1&&this.changeObjAlphasInLocation(1,{c:b.c,r:b.r+1}),c.c>0&&this.changeObjAlphasInLocation(.7,{c:c.c-1,r:c.r}),c.c>0&&c.r<this.mapSizeR-1&&this.changeObjAlphasInLocation(.7,{c:c.c-1,r:c.r+1}),c.r<this.mapSizeR-1&&this.changeObjAlphasInLocation(.7,{c:c.c,r:c.r+1})),a.alpha=1},b.EngineView.prototype.arrangeDepthsFromLocation=function(a){var b,c,d,e;for(c=a.r;c<this.mapSizeR;c++)for(d=a.c;d>=0;d--)if(b=this.objArray[c][d])for(e=0;e<b.length;e++)this.objContainer.addChild(b[e])},b.EngineView.prototype.arrangePathHighlight=function(a,b){var c,d,e;if(a)for(c=0;c<a.length;c++)e=a[c],-1===b.indexOf(e)&&(d=this.tileArray[e.mapPos.r][e.mapPos.c],d.setHighlighted(!1,!this.config.tileHighlightAnimated));for(c=0;c<b.length;c++)e=b[c],a&&-1!==a.indexOf(e)||(d=this.tileArray[e.mapPos.r][e.mapPos.c],d.setHighlighted(!0,!this.config.tileHighlightAnimated))},b.EngineView.prototype.moveObjThrough=function(a,b,c){if(this.config.instantObjectRelocation){var d=this.tileArray[b[0].mapPos.r][b[0].mapPos.c];a.position.x=d.position.x,a.position.y=d.position.y+this.TILE_HALF_H,this.arrangeObjTransperancies(a,a.mapPos,d.mapPos),this.arrangeObjLocation(a,d.mapPos),this.arrangeDepthsFromLocation(d.mapPos)}else this.config.highlightPath&&this.currentControllable===a&&this.arrangePathHighlight(a.currentPath,b),a.currentTarget?this.moveEngine.addNewPathToObject(a,b,c):(this.moveEngine.prepareForMove(a,b,c),a.currentTargetTile=a.currentPath[a.currentPathStep],this.onObjMoveStepBegin(a,a.currentPath[a.currentPathStep].mapPos))},b.EngineView.prototype.onObjMoveStepBegin=function(a,c){return a.currentDirection=b.getDirBetween(a.mapPos.r,a.mapPos.c,c.r,c.c),a.changeVisualToDirection(a.currentDirection,!0),this.pathFinding.isCellFilled(c.c,c.r)?(this.moveEngine.removeMovable(a),this.checkAndMoveObjectToLocation(a,a.currentPath[0].mapPos),!1):(this.moveEngine.setMoveParameters(a,c),this.moveEngine.addMovable(a),!0)},b.EngineView.prototype.onObjMoveStepEnd=function(a){a.currentPathStep--,a.currentTarget=null,a.currentTargetTile=null;var b=0>a.currentPathStep;if(this.moveEngine.removeMovable(a),b?a.changeVisualToDirection(a.currentDirection,!1):this.checkAndMoveObjectToLocation(a,a.currentPath[0].mapPos),this.currentControllable===a){var c=this.tileArray[a.mapPos.r][a.mapPos.c];c.setHighlighted(!1,!this.config.tileHighlightAnimated),this.config.followCharacter&&this.centralizeToLocation(a.mapPos.c,a.mapPos.r)}b&&this.config.objectReachedDestinationCallback&&this.config.objectReachedDestinationCallback.call(this.config.callbackScope,a)},b.EngineView.prototype.checkForTileChange=function(a){for(var c={x:a.position.x,y:a.position.y-this.TILE_HALF_H},d=this.tileArray[a.currentTargetTile.mapPos.r][a.currentTargetTile.mapPos.c],e=[],f=0;f<d.vertices.length;f++)e[f]=[d.vertices[f][0]+d.position.x,d.vertices[f][1]+d.position.y];if((a.currentTargetTile.mapPos.r!==a.mapPos.r||a.currentTargetTile.mapPos.c!==a.mapPos.c)&&b.isInPolygon(c,e)){this.arrangeObjTransperancies(a,a.mapPos,a.currentTargetTile.mapPos),this.arrangeObjLocation(a,a.currentTargetTile.mapPos),this.arrangeDepthsFromLocation(a.mapPos);var g=this.getObjectsAtLocation(a.currentTargetTile.mapPos);g&&g.length>1&&this.config.otherObjectsOnTheNextTileCallback&&this.config.otherObjectsOnTheNextTileCallback.call(this.config.callbackScope,a,g)}},b.EngineView.prototype.getPath=function(a,b){if(this.pathFinding)return this.pathFinding.solve(a.c,a.r,b.c,b.r);throw new Error("Path finding hasn't been initialized yet!")},b.EngineView.prototype.checkAndMoveObjectToTile=function(a,b,c){return b.isMovableTo?this.checkAndMoveObjectToLocation(a,b.mapPos,c):!1},b.EngineView.prototype.checkAndMoveObjectToLocation=function(a,b,c){var d=this.getPath(a.mapPos,b);return d?(this.moveObjThrough(a,d,c),d.length):!1},b.EngineView.prototype.moveCurrentControllableToLocation=function(a,b){if(!this.currentControllable)throw new Error("TRAVISO: currentControllable is not defined!");return this.checkAndMoveObjectToLocation(this.currentControllable,a,b)},b.EngineView.prototype.moveCurrentControllableToObj=function(a,b){if(!this.currentControllable)throw new Error("TRAVISO: currentControllable is not defined!");for(var c,d,e,f=this.pathFinding.getAdjacentOpenCells(a.mapPos.c,a.mapPos.r,a.size.c,a.size.r),g=3e3,h=0;h<f.length;h++)if(c=this.tileArray[f[h].mapPos.r][f[h].mapPos.c]){if(c.mapPos.c===this.currentControllable.mapPos.c&&c.mapPos.r===this.currentControllable.mapPos.r)return this.config.objectReachedDestinationCallback&&this.config.objectReachedDestinationCallback.call(this.config.callbackScope,this.currentControllable),!0;d=this.getPath(this.currentControllable.mapPos,c.mapPos),d&&d.length<g&&(g=d.length,e=d)}return e?(this.moveObjThrough(this.currentControllable,e,b),!0):!1},b.EngineView.prototype.getTileFromLocalPos=function(a){var c=null;if(b.isInPolygon(a,this.mapVertices)){var d,e,f,g,h=this.TILE_HALF_W/2,i=3e3;for(e=0;e<this.mapSizeR;e++)for(f=0;f<this.mapSizeC&&(d=this.tileArray[e][f],!(d&&(g=b.getDist(a,d.position),i>g&&(i=g,c=d,h>g))));f++);}return c},b.EngineView.prototype.checkForTileClick=function(a){var c=b.globalToLocal(a.global,this.mapContainer);c={x:c.x/this.currentScale,y:c.y/this.currentScale};var d=this.getTileFromLocalPos(c);if(d){var e=this.objArray[d.mapPos.r][d.mapPos.c];if(e)for(var f=0;f<e.length;f++){if(e[f].isInteractive){this.config.objectSelectCallback&&this.config.objectSelectCallback.call(this.config.callbackScope,e[f]);break}if(e[f].isMovableTo&&(!this.currentControllable||this.checkAndMoveObjectToTile(this.currentControllable,d))){this.config.highlightTargetTile&&d.setHighlighted(!0,!this.config.tileHighlightAnimated),this.config.tileSelectCallback&&this.config.tileSelectCallback.call(this.config.callbackScope,d.mapPos.r,d.mapPos.c);break}}else(!this.currentControllable||this.checkAndMoveObjectToTile(this.currentControllable,d))&&(this.config.highlightTargetTile&&d.setHighlighted(!0,!this.config.tileHighlightAnimated),this.config.tileSelectCallback&&this.config.tileSelectCallback.call(this.config.callbackScope,d.mapPos.r,d.mapPos.c))}},b.EngineView.prototype.enableInteraction=function(){var a=this;this.mousedown=this.touchstart=function(b){a.onMouseDown(b)},this.mousemove=this.touchmove=function(b){a.onMouseMove(b)},this.mouseup=this.mouseupout=this.touchend=function(b){a.onMouseUp(b)},this.interactive=!0},b.EngineView.prototype.disableInteraction=function(){this.mousedown=this.touchstart=null,this.mousemove=this.touchmove=null,this.mouseup=this.mouseupout=this.touchend=null,this.interactive=!0,this.dragging=!1},b.EngineView.prototype.isInteractionInMask=function(a){return this.config.useMask&&(a.x<this.posFrame.x||a.y<this.posFrame.y||a.x>this.posFrame.x+this.posFrame.w||a.y>this.posFrame.y+this.posFrame.h)?!1:!0},b.EngineView.prototype.onMouseDown=function(a){!this.dragging&&this.isInteractionInMask(a.global)&&(this.dragging=!0,this.dragInitStartingX=this.dragPrevStartingX=a.global.x,this.dragInitStartingY=this.dragPrevStartingY=a.global.y)},b.EngineView.prototype.onMouseMove=function(a){this.dragging&&this.config.mapDraggable&&(this.mapContainer.position.x+=a.global.x-this.dragPrevStartingX,this.mapContainer.position.y+=a.global.y-this.dragPrevStartingY,this.dragPrevStartingX=a.global.x,this.dragPrevStartingY=a.global.y)},b.EngineView.prototype.onMouseUp=function(a){if(this.dragging){this.dragging=!1;var b=a.global.x-this.dragInitStartingX,c=a.global.y-this.dragInitStartingY;Math.abs(b)<5&&Math.abs(c)<5&&this.checkForTileClick(a)}},b.EngineView.prototype.repositionContent=function(a){b.trace("EngineView repositionContent"),a=a||this.posFrame||{x:0,y:0,w:800,h:600},this.position.x=a.x,this.position.y=a.y,this.externalCenter={x:a.w>>1,y:a.h>>1},this.centralizeToCurrentFocusLocation(!0),this.bg&&(this.bg.clear(),this.bg.beginFill(this.config.backgroundColor,1),this.bg.drawRect(0,0,a.w,a.h),this.bg.endFill()),this.mapMask&&this.mapContainer&&(this.mapMask.clear(),this.mapMask.beginFill("#000000"),this.mapMask.drawRect(0,0,a.w,a.h),this.mapMask.endFill(),this.mapContainer.mask=this.mapMask),this.posFrame=a},b.EngineView.prototype.destroy=function(){b.trace("EngineView destroy"),this.disableInteraction(),this.moveEngine.destroy(),this.moveEngine=null;var a,c,d,e;for(c=0;c<this.mapSizeR;c++)for(d=this.mapSizeC-1;d>=0;d--){if(a=this.tileArray[c][d],a&&a.destroy(),this.tileArray[c][d]=null,a=this.objArray[c][d])for(e=0;e<a.length;e++)a[e]&&a[e].destroy(),a[e]=null;this.objArray[c][d]=null}a=null,this.pathFinding.destroy(),this.pathFinding=null,this.currentControllable=null,this.tileArray=null,this.objArray=null,this.bg=null,this.groundContainer=null,this.objContainer=null,this.mapContainer&&(this.mapContainer.mask=null,this.removeChild(this.mapContainer),this.mapContainer=null),this.mapMask&&(this.removeChild(this.mapMask),this.mapMask=null),this.config=null,this.mapData.groundMapData=null,this.mapData.objectsMapData=null,this.mapData.textures.tiles=null,this.mapData.textures.objects=null,this.mapData.textures=null,this.mapData=null},"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=b),exports.TRAVISO=b):"undefined"!=typeof define&&define.amd?define(b):a.TRAVISO=b}).call(this);